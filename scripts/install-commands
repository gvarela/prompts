#!/usr/bin/env bash
#
# install-commands - Install planning commands to Claude Code and/or AmpCode
#
# Usage:
#   ./scripts/install-commands --claude         # Install to Claude Code globally
#   ./scripts/install-commands --amp            # Install to AmpCode globally
#   ./scripts/install-commands --both           # Install to both globally
#   ./scripts/install-commands --claude --project  # Install to Claude Code in current project
#   ./scripts/install-commands --amp --project     # Install to AmpCode in current project
#   ./scripts/install-commands --both --project    # Install to both in current project
#   ./scripts/install-commands --help           # Show this help message

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Installation targets
INSTALL_CLAUDE=false
INSTALL_AMP=false
INSTALL_PROJECT=false
PROJECT_PATH=""
SKIP_CONFIRM=false

# Function to print colored output
print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

# Function to show help
show_help() {
    cat << EOF
Install planning commands to Claude Code and/or AmpCode

Usage:
  ./scripts/install-commands [OPTIONS]

Options:
  --claude          Install to Claude Code (uses symlinks)
  --amp             Install to AmpCode (uses copies)
  --both            Install to both Claude Code and AmpCode
  --project <path>  Install to project at specified path (default: global)
  --yes, -y         Skip confirmation prompts
  --help            Show this help message

Examples:
  # Install globally to Claude Code
  ./scripts/install-commands --claude

  # Install globally to both
  ./scripts/install-commands --both

  # Install to a specific project's Claude Code commands
  ./scripts/install-commands --claude --project /path/to/project

  # Install to a specific project's AmpCode commands
  ./scripts/install-commands --amp --project ~/my-project

Installation Locations:
  Claude Code (global):  ~/.claude/commands/wb/, ~/.claude/agents/wb/, ~/.claude/skills/
  Claude Code (project): <project-path>/.claude/commands/wb/, agents/wb/, skills/
  AmpCode (global):      ~/.config/amp/commands/ (flat structure)
  AmpCode (project):     <project-path>/.agents/commands/ (flat structure)

Symlinks vs Copies:

  Claude Code (uses symlinks):
    • Commands: Individual .md files symlinked from claude-code/commands/wb/*.md
    • Agents:   Individual .md files symlinked from claude-code/agents/wb/*.md
    • Skills:   Entire directories symlinked from claude-code/skills/*/
    • Benefit:  Edits to source files immediately reflect in installation
    • Updates:  Automatic via 'git pull' - no reinstall needed

  AmpCode (uses copies):
    • Commands: Files copied (not symlinked) to flat directory structure
    • Updates:  Re-run ./scripts/install-commands --amp to update
    • Why:      AmpCode doesn't follow symlinks

  Installation Notes:
    • Global installations require target directory to exist (or confirm creation)
    • Project installations create directories automatically
    • Symlinks point to absolute paths in this repository

EOF
}

# Function to get commands directories based on tool
get_commands_dirs() {
    local tool=$1
    if [ "$tool" = "claude" ]; then
        echo "$REPO_ROOT/claude-code/commands/wb"
        echo "$REPO_ROOT/claude-code/agents/wb"
        echo "$REPO_ROOT/claude-code/skills"
    elif [ "$tool" = "amp" ]; then
        echo "$REPO_ROOT/ampcode/commands/planning"
        echo "$REPO_ROOT/ampcode/commands/actions"
    fi
}

# Function to validate commands directory
validate_commands_dir() {
    local commands_dir=$1
    local dir_name=$2

    if [ ! -d "$commands_dir" ]; then
        print_error "$dir_name directory not found: $commands_dir"
        exit 1
    fi

    local count
    count=$(find "$commands_dir" -maxdepth 1 -name "*.md" -type f ! -name "README.md" ! -name "CLAUDE.md" ! -name "AGENTS.md" | wc -l)
    if [ "$count" -eq 0 ]; then
        print_error "No command files found in: $commands_dir"
        exit 1
    fi

    print_success "Found $count files in $dir_name"
}

# Function to get target directories
get_target_dirs() {
    local tool=$1
    local scope=$2
    local project_path=$3

    if [ "$tool" = "claude" ]; then
        if [ "$scope" = "global" ]; then
            echo "$HOME/.claude/commands/wb"
            echo "$HOME/.claude/agents/wb"
            echo "$HOME/.claude/skills"
        else
            echo "${project_path}/.claude/commands/wb"
            echo "${project_path}/.claude/agents/wb"
            echo "${project_path}/.claude/skills"
        fi
    elif [ "$tool" = "amp" ]; then
        # AmpCode uses flat directory structure - return same dir twice for compatibility
        if [ "$scope" = "global" ]; then
            local base_dir
            if [ -n "${XDG_CONFIG_HOME:-}" ]; then
                base_dir="$XDG_CONFIG_HOME/amp/commands"
            else
                base_dir="$HOME/.config/amp/commands"
            fi
            echo "${base_dir}"
            echo "${base_dir}"
        else
            echo "${project_path}/.agents/commands"
            echo "${project_path}/.agents/commands"
        fi
    fi
}

# Function to ensure directory exists
ensure_directory() {
    local dir=$1
    local scope=$2

    if [ -d "$dir" ]; then
        print_info "Directory exists: $dir"
        return 0
    fi

    if [ "$scope" = "global" ]; then
        print_warning "Directory does not exist: $dir"
        if [ "$SKIP_CONFIRM" = false ]; then
            read -p "Create it? (y/n) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                print_error "Installation cancelled"
                return 1
            fi
        fi
    fi

    mkdir -p "$dir"
    print_success "Created directory: $dir"
}

# Function to configure SessionStart hook in settings.json
configure_sessionstart_hook() {
    local settings_file=$1
    local scope=$2

    # Check if file exists and has the hook already
    if [ -f "$settings_file" ]; then
        if grep -q "setup-beads-mode.sh" "$settings_file" 2>/dev/null; then
            print_info "SessionStart hook already configured in settings"
            return 0
        fi
    fi

    # Offer to configure automatically
    print_info "SessionStart hook not configured in $(basename "$settings_file")"
    echo
    if [ "$SKIP_CONFIRM" = false ]; then
        echo "This hook auto-detects beads mode (stealth vs git) and is used by wb commands."
        read -p "Configure SessionStart hook automatically? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Skipped. You can configure it manually later (see .claude/hooks/README.md)"
            return 0
        fi
    fi

    # Create or update settings file
    local temp_file
    temp_file=$(mktemp)

    if [ -f "$settings_file" ] && [ -s "$settings_file" ]; then
        # File exists and is not empty - need to merge
        # Check if it has a hooks section already
        if grep -q '"hooks"' "$settings_file" 2>/dev/null; then
            print_warning "settings.json already has a hooks section - manual merge required"
            print_info "Add this to your hooks.SessionStart array in $settings_file:"
            cat << 'EOF'
      {
        "hooks": [
          {
            "type": "command",
            "command": "./.claude/hooks/setup-beads-mode.sh",
            "timeout": 5,
            "statusMessage": "Detecting beads mode"
          }
        ]
      }
EOF
            rm "$temp_file"
            return 0
        else
            # Add hooks section to existing file
            # Remove closing brace, add hooks, add closing brace
            head -n -1 "$settings_file" > "$temp_file"
            cat >> "$temp_file" << 'EOF'
  ,
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "./.claude/hooks/setup-beads-mode.sh",
            "timeout": 5,
            "statusMessage": "Detecting beads mode"
          }
        ]
      }
    ]
  }
}
EOF
        fi
    else
        # Create new file
        cat > "$temp_file" << 'EOF'
{
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "./.claude/hooks/setup-beads-mode.sh",
            "timeout": 5,
            "statusMessage": "Detecting beads mode"
          }
        ]
      }
    ]
  }
}
EOF
    fi

    # Backup existing file if it exists
    if [ -f "$settings_file" ]; then
        cp "$settings_file" "${settings_file}.backup"
        print_info "Backed up existing settings to ${settings_file}.backup"
    fi

    # Move temp file to settings file
    mv "$temp_file" "$settings_file"
    print_success "Configured SessionStart hook in $(basename "$settings_file")"
}

# Function to install commands to a target directory
install_to_target() {
    local target_dir=$1
    local tool_name=$2
    local scope=$3
    local use_symlinks=$4  # true for Claude Code, false for AmpCode
    local commands_dir=$5
    local prefix=$6  # prefix for AmpCode files (e.g., "planning_" or "actions_")

    print_info "Installing to $tool_name ($scope): $target_dir"

    # Ensure target directory exists
    if ! ensure_directory "$target_dir" "$scope"; then
        return 1
    fi

    local installed_count=0
    local skipped_count=0

    # Install each command file
    for cmd_file in "$commands_dir"/*.md; do
        local basename
        basename=$(basename "$cmd_file")

        # Skip documentation files
        if [[ "$basename" == "CLAUDE.md" ]] || \
           [[ "$basename" == "AGENTS.md" ]] || \
           [[ "$basename" == "README.md" ]]; then
            continue
        fi

        # For AmpCode with prefix, prepend it to filename
        local target_basename="$basename"
        if [ -n "$prefix" ]; then
            target_basename="${prefix}${basename}"
        fi

        local target_file="$target_dir/$target_basename"

        # For symlinks (Claude Code)
        if [ "$use_symlinks" = true ]; then
            # Check if symlink already exists and points to correct location
            if [ -L "$target_file" ]; then
                local current_target
                current_target=$(readlink "$target_file")
                if [ "$current_target" = "$cmd_file" ]; then
                    print_info "  $target_basename (already installed)"
                    ((skipped_count++))
                    continue
                else
                    print_warning "  $target_basename (updating symlink)"
                    rm "$target_file"
                fi
            elif [ -e "$target_file" ]; then
                print_warning "  $target_basename (file exists, skipping)"
                ((skipped_count++))
                continue
            fi

            # Create symlink
            ln -s "$cmd_file" "$target_file"
            print_success "  $target_basename"
            ((installed_count++))
        else
            # For copies (AmpCode)
            if [ -e "$target_file" ]; then
                # Check if file is identical
                if cmp -s "$cmd_file" "$target_file"; then
                    print_info "  $target_basename (already up to date)"
                    ((skipped_count++))
                    continue
                else
                    print_warning "  $target_basename (updating)"
                    rm "$target_file"
                fi
            fi

            # Copy file
            cp "$cmd_file" "$target_file"
            print_success "  $target_basename"
            ((installed_count++))
        fi
    done

    echo
    print_success "$tool_name ($scope): Installed $installed_count commands, skipped $skipped_count"
    return 0
}

# Function to install skills to a target directory
install_skills_to_target() {
    local target_dir=$1
    local tool_name=$2
    local scope=$3
    local skills_dir=$4

    print_info "Installing to $tool_name ($scope): $target_dir"

    # Ensure target directory exists
    if ! ensure_directory "$target_dir" "$scope"; then
        return 1
    fi

    local installed_count=0
    local skipped_count=0

    # Install each skill directory
    for skill_dir in "$skills_dir"/*; do
        # Skip if not a directory
        if [ ! -d "$skill_dir" ]; then
            continue
        fi

        local skill_name
        skill_name=$(basename "$skill_dir")

        # Skip if SKILL.md doesn't exist
        if [ ! -f "$skill_dir/SKILL.md" ]; then
            print_warning "  $skill_name (no SKILL.md, skipping)"
            continue
        fi

        local target_skill="$target_dir/$skill_name"

        # Check if symlink already exists and points to correct location
        if [ -L "$target_skill" ]; then
            local current_target
            current_target=$(readlink "$target_skill")
            if [ "$current_target" = "$skill_dir" ]; then
                print_info "  $skill_name (already installed)"
                ((skipped_count++))
                continue
            else
                print_warning "  $skill_name (updating symlink)"
                rm "$target_skill"
            fi
        elif [ -e "$target_skill" ]; then
            print_warning "  $skill_name (directory exists, skipping)"
            ((skipped_count++))
            continue
        fi

        # Create symlink to skill directory
        ln -s "$skill_dir" "$target_skill"
        print_success "  $skill_name"
        ((installed_count++))
    done

    echo
    print_success "$tool_name ($scope): Installed $installed_count skills, skipped $skipped_count"
    return 0
}

# Parse command line arguments
if [ $# -eq 0 ]; then
    print_error "No options specified"
    echo
    show_help
    exit 1
fi

while [ $# -gt 0 ]; do
    case $1 in
        --claude)
            INSTALL_CLAUDE=true
            shift
            ;;
        --amp)
            INSTALL_AMP=true
            shift
            ;;
        --both)
            INSTALL_CLAUDE=true
            INSTALL_AMP=true
            shift
            ;;
        --project)
            INSTALL_PROJECT=true
            shift
            if [ $# -eq 0 ] || [[ "$1" == --* ]]; then
                print_error "--project requires a path argument"
                echo
                show_help
                exit 1
            fi
            PROJECT_PATH="$1"
            shift
            ;;
        --yes|-y)
            SKIP_CONFIRM=true
            shift
            ;;
        --help)
            show_help
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            echo
            show_help
            exit 1
            ;;
    esac
done

# Validate that at least one tool was selected
if [ "$INSTALL_CLAUDE" = false ] && [ "$INSTALL_AMP" = false ]; then
    print_error "Must specify --claude, --amp, or --both"
    echo
    show_help
    exit 1
fi

# Determine installation scope
SCOPE="global"
if [ "$INSTALL_PROJECT" = true ]; then
    SCOPE="project"

    # Validate and normalize project path
    if [ -z "$PROJECT_PATH" ]; then
        print_error "--project flag requires a path argument"
        exit 1
    fi

    # Expand tilde if present
    PROJECT_PATH="${PROJECT_PATH/#\~/$HOME}"

    # Convert to absolute path
    if [[ "$PROJECT_PATH" != /* ]]; then
        PROJECT_PATH="$(cd "$PROJECT_PATH" 2>/dev/null && pwd)" || {
            print_error "Project path does not exist: $PROJECT_PATH"
            exit 1
        }
    fi

    # Verify directory exists
    if [ ! -d "$PROJECT_PATH" ]; then
        print_error "Project path does not exist: $PROJECT_PATH"
        exit 1
    fi

    print_info "Project path: $PROJECT_PATH"
fi

echo
print_info "Installation Configuration:"
echo "  Scope: $SCOPE"
if [ "$SCOPE" = "project" ]; then
    echo "  Project: $PROJECT_PATH"
fi
echo "  Claude Code: $INSTALL_CLAUDE"
echo "  AmpCode: $INSTALL_AMP"
echo

# Confirm installation
if [ "$SKIP_CONFIRM" = false ]; then
    read -p "Proceed with installation? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_error "Installation cancelled"
        exit 1
    fi
fi

echo

# Install to Claude Code
if [ "$INSTALL_CLAUDE" = true ]; then
    # Get source directories (line by line)
    CLAUDE_SOURCES=()
    while IFS= read -r line; do
        CLAUDE_SOURCES+=("$line")
    done < <(get_commands_dirs "claude")

    # Get target directories
    CLAUDE_TARGETS=()
    while IFS= read -r line; do
        CLAUDE_TARGETS+=("$line")
    done < <(get_target_dirs "claude" "$SCOPE" "$PROJECT_PATH")

    # Install workbench commands
    print_info "Installing Claude Code Workbench Commands..."
    validate_commands_dir "${CLAUDE_SOURCES[0]}" "workbench commands"
    if ! install_to_target "${CLAUDE_TARGETS[0]}" "Claude Code Workbench Commands" "$SCOPE" true "${CLAUDE_SOURCES[0]}" ""; then
        print_error "Failed to install Claude Code workbench commands"
        exit 1
    fi
    echo

    # Install workbench agents
    print_info "Installing Claude Code Workbench Agents..."
    validate_commands_dir "${CLAUDE_SOURCES[1]}" "workbench agents"
    if ! install_to_target "${CLAUDE_TARGETS[1]}" "Claude Code Workbench Agents" "$SCOPE" true "${CLAUDE_SOURCES[1]}" ""; then
        print_error "Failed to install Claude Code workbench agents"
        exit 1
    fi
    echo

    # Install skills
    print_info "Installing Claude Code Skills..."
    if [ -d "${CLAUDE_SOURCES[2]}" ]; then
        if ! install_skills_to_target "${CLAUDE_TARGETS[2]}" "Claude Code Skills" "$SCOPE" "${CLAUDE_SOURCES[2]}"; then
            print_error "Failed to install Claude Code skills"
            exit 1
        fi
    else
        print_warning "Skills directory not found: ${CLAUDE_SOURCES[2]}"
    fi
    echo

    # Install hooks
    print_info "Installing Claude Code Hooks..."
    if [ -d "$REPO_ROOT/.claude/hooks" ]; then
        local hooks_target
        if [ "$SCOPE" = "global" ]; then
            hooks_target="$HOME/.claude/hooks"
        else
            hooks_target="${PROJECT_PATH}/.claude/hooks"
        fi

        # Ensure hooks directory exists
        if ! ensure_directory "$hooks_target" "$SCOPE"; then
            print_warning "Failed to create hooks directory, skipping hooks installation"
        else
            local installed_hooks=0
            local skipped_hooks=0

            # Install each hook script
            for hook_file in "$REPO_ROOT/.claude/hooks"/*.sh; do
                if [ -f "$hook_file" ]; then
                    local hook_name
                    hook_name=$(basename "$hook_file")
                    local target_hook="$hooks_target/$hook_name"

                    # Check if symlink already exists and points to correct location
                    if [ -L "$target_hook" ]; then
                        local current_target
                        current_target=$(readlink "$target_hook")
                        if [ "$current_target" = "$hook_file" ]; then
                            print_info "  $hook_name (already installed)"
                            ((skipped_hooks++))
                            continue
                        else
                            print_warning "  $hook_name (updating symlink)"
                            rm "$target_hook"
                        fi
                    elif [ -e "$target_hook" ]; then
                        print_warning "  $hook_name (file exists, skipping)"
                        ((skipped_hooks++))
                        continue
                    fi

                    # Create symlink and make executable
                    ln -s "$hook_file" "$target_hook"
                    chmod +x "$hook_file"
                    print_success "  $hook_name"
                    ((installed_hooks++))
                fi
            done

            if [ $installed_hooks -gt 0 ] || [ $skipped_hooks -gt 0 ]; then
                print_success "Hooks: Installed $installed_hooks, skipped $skipped_hooks"
                echo

                # Configure SessionStart hook
                local settings_file
                if [ "$SCOPE" = "global" ]; then
                    settings_file="$HOME/.claude/settings.json"
                else
                    settings_file="${PROJECT_PATH}/.claude/settings.json"
                fi

                configure_sessionstart_hook "$settings_file" "$SCOPE"
            fi
        fi
    fi
    echo
fi

# Install to AmpCode
if [ "$INSTALL_AMP" = true ]; then
    # Get source directories (line by line)
    AMP_SOURCES=()
    while IFS= read -r line; do
        AMP_SOURCES+=("$line")
    done < <(get_commands_dirs "amp")

    # Get target directories
    AMP_TARGETS=()
    while IFS= read -r line; do
        AMP_TARGETS+=("$line")
    done < <(get_target_dirs "amp" "$SCOPE" "$PROJECT_PATH")

    # Install planning commands (no prefix)
    print_info "Installing AmpCode Planning Commands..."
    validate_commands_dir "${AMP_SOURCES[0]}" "planning"
    if ! install_to_target "${AMP_TARGETS[0]}" "AmpCode Planning" "$SCOPE" false "${AMP_SOURCES[0]}" ""; then
        print_error "Failed to install AmpCode planning commands"
        exit 1
    fi
    echo

    # Install action commands (no prefix)
    print_info "Installing AmpCode Action Commands..."
    validate_commands_dir "${AMP_SOURCES[1]}" "actions"
    if ! install_to_target "${AMP_TARGETS[1]}" "AmpCode Actions" "$SCOPE" false "${AMP_SOURCES[1]}" ""; then
        print_error "Failed to install AmpCode action commands"
        exit 1
    fi
    echo
fi

# Final summary
echo
print_success "Installation complete!"
echo
print_info "Next steps:"

if [ "$INSTALL_CLAUDE" = true ]; then
    echo "  • Test Claude Code commands with: /wb:create_project test-feature"
    if [ "$SCOPE" = "global" ]; then
        echo "  • Commands available in all projects using Claude Code"
        echo "  • Hooks installed to ~/.claude/hooks/ (beads mode auto-detection)"
    else
        echo "  • Commands available in this project only"
        echo "  • Hooks installed to project .claude/hooks/"
    fi
fi

if [ "$INSTALL_AMP" = true ]; then
    echo "  • Test AmpCode commands with: /create_project test-feature"
    if [ "$SCOPE" = "global" ]; then
        echo "  • Commands available in all projects using AmpCode"
    else
        echo "  • Commands available in this project only"
    fi
fi

echo
if [ "$INSTALL_CLAUDE" = true ] && [ "$INSTALL_AMP" = false ]; then
    print_info "To update commands: cd $REPO_ROOT && git pull"
    print_info "Claude Code commands will automatically reflect updates via symlinks"
elif [ "$INSTALL_AMP" = true ] && [ "$INSTALL_CLAUDE" = false ]; then
    print_info "To update commands: cd $REPO_ROOT && git pull && ./scripts/install-commands --amp"
    if [ "$SCOPE" = "project" ]; then
        print_info "Use --project $PROJECT_PATH when updating"
    fi
else
    print_info "To update commands: cd $REPO_ROOT && git pull"
    print_info "Claude Code: Updates automatically via symlinks"
    print_info "AmpCode: Re-run ./scripts/install-commands --amp to update"
    if [ "$SCOPE" = "project" ]; then
        print_info "Use --project $PROJECT_PATH when updating AmpCode"
    fi
fi
